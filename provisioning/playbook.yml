---
- hosts: all

  tasks:

    # run

    - name: Install postgresql
      apt: pkg=postgresql
      sudo: yes
      tags: run

    - name: Install java
      apt: pkg=openjdk-7-jre
      sudo: yes
      tags: run

    - name: Install tomcat
      apt: pkg=tomcat6
      sudo: yes
      tags: run

    - name: Install tomcat native
      apt: pkg=libtcnative-1
      sudo: yes
      tags: run

    - name: Install solr-tomcat
      apt: pkg=solr-tomcat
      sudo: yes
      tags: run

    - name: Install apache
      apt: pkg=apache2
      sudo: yes
      tags: run
      notify:
      - Generate SSL certificate
      - Create BookMate document root
      - Add placeholder .html
      - Setup VirtualHost
      - Disable default VirtualHost
      - Enable VirtualHost
      - Install Apache module
      - Set ServerName
      - Restart apache

    # manage

    - name: Install phppgadmin
      apt: pkg=phppgadmin
      sudo: yes
      tags: manage
      notify:
      - Add phppgadmin configuration
      - Remove phppgadmin configuration
      - Create phppgadmin symlink
      - Restart apache

    - name: Install tomcat6-admin
      apt: pkg=tomcat6-admin
      sudo: yes
      tags: manage

    # development

    - name: Install maven
      apt: pkg=maven2
      sudo: yes
      tags: development

    - name: Install git
      apt: pkg=git-core
      sudo: yes
      tags: development

    - name: Install avahi
      apt: pkg=avahi-daemon
      sudo: yes
      tags: development

  handlers:

    - name: Generate SSL certificate
      command: openssl req -new -nodes -x509 -subj "/C=AU/ST=Victoria/L=Selby/O=IT/CN=vagrant-bookmate.local" -days 3650 -keyout /etc/ssl/private/Qualis.key -out /etc/ssl/certs/Qualis.crt -extensions v3_ca creates=/etc/ssl/certs/Qualis.crt
      sudo: yes

    - name: Disable default VirtualHost
      shell: a2dissite 000-default
      sudo: yes

    - name: Create BookMate document root
      file: path=/BookMate/browser state=directory owner=www-data group=www-data
      sudo: yes

    - name: Add placeholder .html
      copy: src=resource/placeholder.html dest=/BookMate/browser/index.html owner=www-data group=www-data
      sudo: yes

    - name: Setup VirtualHost
      copy: src=resource/virtualhost dest=/etc/apache2/sites-available/qualis.conf owner=www-data group=www-data
      sudo: yes

    - name: Enable VirtualHost
      shell: a2ensite qualis
      sudo: yes

    - name: Install Apache module
      apache2_module: state=present name={{item}}
      with_items:
        - ssl
        - proxy_http
      sudo: yes

    - name: Set ServerName
      lineinfile: dest=/etc/apache2/apache2.conf line="ServerName localhost"
      sudo: yes

    - name: Add phppgadmin configuration
      lineinfile: dest=/etc/apache2/conf.d/phppgadmin line="allow from all" insertafter='deny from all'
      sudo: yes

    - name: Remove phppgadmin configuration
      lineinfile: dest=/etc/apache2/conf.d/phppgadmin line='{{item}}' state=absent
      with_items:
        - 'deny from all'
        - 'allow from 127.0.0.0/255.0.0.0 ::1/128'
      sudo: yes

    - name: Create phppgadmin symlink
      file: src=/etc/apache2/conf.d/phppgadmin dest=/etc/apache2/conf-enabled/phppgadmin.conf state=link owner=www-data group=www-data
      sudo: yes

    - name: Restart apache
      service: name=apache2 state=restarted
      sudo: yes
